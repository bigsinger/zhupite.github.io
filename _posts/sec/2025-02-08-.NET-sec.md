---
layout:		post
category:	"sec"
title:		".NET逆向工程"

tags:		[]
---
- Content
{:toc}


# 工具

- [dnSpy](https://github.com/dnSpy/dnSpy)：强烈推荐优先使用，功能强大。`dnSpy` 是最简单的方法，支持 C# 和 IL 直接修改，推荐使用。可以直接对二进制文件编辑函数代码并重新编译为新的二进制文件，这点非常强大。另外逆向保存源码工程时xaml文件和cs源码文件的组织也是正确的。不过可惜的是2020年之后就没有再更新了。
- [ILSpy](https://github.com/icsharpcode/ILSpy)：逆向保存源码工程较强，可以生成xaml文件，但是目录结构组织的不对，需要手动调整，工作量较大，但是至少可行。一直在更新。可以配合 [Reflexil](https://github.com/sailro/Reflexil) 使用，不过后者也不再更新了。
- .NET Reflector：保存工程的时候xaml文件不会生成，网上可以找到断网注册版，不过不是最新版，最新版本不确定是否可行。
- **ILDasm & ILAsm**（.NET SDK 自带）：用于反汇编和重组装。
- **signtool.exe**（如应用有签名）：用于重新签名。

## dnSpy

强烈推荐优先使用，功能强大。

如果只是想要简单破解下软件功能，则可以直接在dnSpy里编辑对应的函数代码（C#），修改后编译下，最后保存全部就可以生成一个新的二进制文件，直接可以使用。

如果想要反编译出源码工程，选择菜单「**导出到工程**」即可，不过因为版本较老，可能会出现一些问题，如果问题较多，可以使用`ILSpy`试试。



## ILSpy

使用**ILSpy**推荐的做法是，新建一个工程然后参考反编译后的源码项目一一复检，代码直接复制粘贴，这样重建的VisualStudio工程问题最少，后期也方便开发维护，比在原有工程上解决问题要省心很多。

**反编译后的工程错误及解决方法：**

- 错误：

```
找不到 ,NETFramework,Version=v4.6,2的引用程序集。要解决此问题，请为此框架版本安装开发人员工具包(SDK/目标包)或者重新定向应用程序。
```

- 解决：在`powershell`中执行如下的命令查看本地安装的`.NET Framework`版本，然后为工程选择一个本地有的版本即可，例如4.8。

```
Get-ChildItem 'HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP' -Recurse | Get-ItemProperty -Name Version,Release -EA 0 | Where { $_.PSChildName -match '^(?!S)\p{L}'} | Select PSChildName, Version, Release
```



- 错误：

```
.g.cs(87,34,87,49): error CS0111: 类型“XXXXX”已定义了一个名为“_CreateDelegate”的具有相同参数类型的成员
```

- 解决：反编译时重复生成了代码，需要在工程中全部搜索`_CreateDelegate`，然后删除所有如下代码即可：

```csharp
[DebuggerNonUserCode]
[GeneratedCode("PresentationBuildTasks", "4.0.0.0")]
internal Delegate _CreateDelegate(Type delegateType, string handler)
{
	return Delegate.CreateDelegate(delegateType, this, handler);
}
```



- 错误：找不到Form或其他控件的定义。
- 解决：项目添加引用`System.Windows.Form`



## ILDasm & ILAsm

1. 使用 ILDasm 反汇编：

   ```sh
   ildasm target.exe /out=target.il
   ```

2. 在 `target.il` 找到目标函数并修改 IL：

   ```IL
   .method public hidebysig instance bool 
           CheckLicense() cil managed
   {
       // 替换现有逻辑，直接返回 true
       .maxstack 1
       ldci4.1  // 1 = true
       ret
   }
   ```

3. 使用 ILAsm 重新编译：

   ```sh
   ilasm target.il /output=patched.exe
   ```

4. 重新打包

如果原应用程序有强名称（strong name），需要去除签名：

```sh
sn -Vr target.exe
```

重新签名：

```sh
sn -R target.exe key.snk
```

运行 `patched.exe` 进行测试，确保修改生效。
